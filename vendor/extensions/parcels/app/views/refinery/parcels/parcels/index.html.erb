<% content_for :body do %>
  <h4>Add Parcel</h4>

  <section class="add_parcels">
    <%= form_for @parcel, url: refinery.parcels_parcels_path do |f| -%>

      <div class="row">
        <div class="medium-2 columns">
          <div class='field'>
            <%= f.label :parcel_date -%>
            <%= f.text_field :parcel_date, value: @parcel.parcel_date || Date.today, class: 'js_parcel_date_field' -%>
          </div>
        </div>

        <div class="medium-2 columns">
          <div class='field'>
            <%= f.label :from -%>
            <%= f.text_field :from, autofocus: true, class: 'js_from_field' -%>
          </div>
        </div>

        <div class="medium-1 columns">
          <div class='field'>
            <%= f.label :courier -%>
            <%= f.text_field :courier -%>
          </div>
        </div>

        <div class="medium-2 columns">
          <div class='field'>
            <%= f.label :air_waybill_no -%>
            <%= f.text_field :air_waybill_no -%>
          </div>
        </div>

        <div class="medium-2 columns">
          <div class='field'>
            <%= f.label :to, 'Addressed To' -%>
            <%= f.text_field :to, class: 'js_to_field' -%>
          </div>
        </div>

        <div class="medium-2 columns">
          <div class='field'>
            <%= f.label :given_to, 'Assign To' -%>
            <%= f.text_field :given_to, class: 'js_given_to_field' -%>
          </div>
        </div>

        <div class="medium-1 columns">
          <div class='field t1'>
            <%= f.submit 'Save', class: 'tiny button round' %>
          </div>
        </div>
      </div>
    <% end -%>

  </section>

  <% if @my_unsigned_parcels.any? %>
    <h4>You need to sign the following Parcels</h4>
    <%= render 'sign_parcel_list', parcels: @my_unsigned_parcels, allow_sign: true %>
  <% end %>

  <table class="display js_parcels_data_table" cellspacing="0" style="width: 100%;">
    <thead>
    <tr>
      <th>Parcel Date</th>
      <th>From</th>
      <th>Courier</th>
      <th>Air Waybill No</th>
      <th>Addressed To</th>
      <th>Assigned To</th>
      <th>Description</th>
      <th>Signed?</th>
    </tr>
    </thead>

    <tfoot>
    <tr>
      <th>Parcel Date</th>
      <th>From</th>
      <th>Courier</th>
      <th>Air Waybill No</th>
      <th>Addressed To</th>
      <th>Assigned To</th>
      <th>Description</th>
      <th>Signed?</th>
    </tr>
    </tfoot>

    <tbody>
    <tr>
      <td colspan="7">Loading, please wait...</td>
    </tr>
    </tbody>
  </table>

<% end %>

<% content_for :stylesheets do %>
  <%= stylesheet_link_tag 'jquery-ui.css' %>
  <%= stylesheet_link_tag 'refinery/ui' %>

  <%= stylesheet_link_tag '//cdn.datatables.net/plug-ins/a5734b29083/integration/foundation/dataTables.foundation.css' %>
<% end %>

<% content_for :javascripts do %>

  <%= javascript_tag do %>
    $(function(){
      $('.js_parcel_date_field').datepicker();
      $('.js_from_field').autocomplete({
        source: <%= ::Refinery::Contacts::Contact.select(:name).map(&:name).to_json.html_safe %>
      });
    <%- users = ::Refinery::User.select(:full_name).map(&:full_name).to_json.html_safe -%>
      $('.js_to_field').autocomplete({
        source: <%= users %>
      });
      $('.js_given_to_field').autocomplete({
        source: <%= users %>
      });
    });
  <% end %>

  <%= javascript_include_tag '//cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js' %>
  <%= javascript_include_tag '//cdn.datatables.net/plug-ins/a5734b29083/integration/foundation/dataTables.foundation.js' %>

  <%= javascript_tag do %>
    $(function(){
      $('.js_parcels_data_table').dataTable({
        "scrollY":        "600px",
        "scrollCollapse": true,
        "paging":         false,
        "order":          [[ 0, "desc" ]],
        "data":           <%= @parcels.to_json(methods: [:given_to]).html_safe %>,
        "columns": [
          { data: "parcel_date", "render": function(data, type, row){ return ('<a href="<%= refinery.parcels_parcel_path('%%parcel_id%%') %>">'+data+'</a>').replace('%%parcel_id%%', row.id); } },
          { data: "from_name" },
          { data: "courier" },
          { data: "air_waybill_no" },
          { data: "to_name" },
          { data: "given_to" },
          { data: "description" },
          { data: "receiver_signed", "render": function(data, type, row) { return (data ? 'Yes' : 'No'); } }
        ]
      });
    });
  <% end %>
<% end %>

<%= render '/refinery/content_page' %>
