<% content_for :actions do %>
  <p><button class="button" data-open="js_invoice_billables_form">Add Billables</button></p>

  <div class="reveal" id="js_invoice_billables_form" data-reveal>
    <%= form_for @invoice_billables_form, url: refinery.add_billables_business_invoice_path(@invoice) do |f| %>
      <h4><%= @invoice_billables_form.non_invoiced_billables.count %> non-invoiced billables available</h4>
      <ul style="max-height: 300px; overflow-y: scroll;">
        <%= f.fields_for :non_invoiced_billables do |ib_form| %>
          <li>
            <%= ib_form.label :invoice_id do %>
              <%= ib_form.check_box :invoice_id, {}, @invoice.id.to_s, '' %>
              <%= ib_form.object.title %>
              <%= ib_form.object.billable_date %>
              <%= ib_form.object.assigned_to_label %>
            <% end %>
          </li>
        <% end %>
      </ul>
      <%= f.submit 'Add' %>
    <% end %>

    <button class="close-button" data-close aria-label="Close modal" type="button">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
<% end %>

<% content_for :body do %>
  <h2><%= @invoice.label %></h2>

  <section class="contact-card">
    <table class="cc-table">
      <tbody>
      <tr>
        <th style="width: 150px;">Company</th>
        <td>
          <% if @invoice.company.present? %>
            <%= link_to @invoice.company.label, refinery.business_company_path(@invoice.company) %>
          <% else %>
            N/A
          <% end %>
        </td>
      </tr>
      <tr>
        <th>Invoice No.</th>
        <td><%= @invoice.invoice_number %></td>
      </tr>
      <tr>
        <th>Type</th>
        <td><%= @invoice.invoice_type %></td>
      </tr>
      <tr>
        <th>Reference</th>
        <td><%= @invoice.reference %></td>
      </tr>
      <tr>
        <th>Invoice Date</th>
        <td><%= @invoice.invoice_date %></td>
      </tr>
      <tr>
        <th>Due Date</th>
        <td><%= @invoice.due_date %></td>
      </tr>
      <tr>
        <th>Status</th>
        <td><%= @invoice.status %></td>
      </tr>
      </tbody>
    </table>

    <h3>Invoice Amount</h3>
    <table class="cc-table">
      <tbody>
      <tr>
        <th style="width: 150px;">Total Amount</th>
        <td><%=number_to_currency @invoice.total_amount, currency: @invoice.currency_code %></td>
      </tr>
      <tr>
        <th>Billable Amount</th>
        <td>
          <%=number_to_currency @invoice.total_cost_from_billables %>
          <% if @invoice.billable_cost_diff != 0 %>
            (<span style="color: #C1666B;"><%=number_to_currency @invoice.billable_cost_diff %></span>)
          <% end %>
        </td>
      </tr>
      <tr>
        <th>Amount Due</th>
        <td><%=number_to_currency @invoice.amount_due, currency: @invoice.currency_code %></td>
      </tr>
      <tr>
        <th>Amount Paid</th>
        <td><%=number_to_currency @invoice.amount_paid, currency: @invoice.currency_code %></td>
      </tr>
      <tr>
        <th>Amount Credited</th>
        <td><%=number_to_currency @invoice.amount_credited, currency: @invoice.currency_code %></td>
      </tr>
      </tbody>
    </table>

    <h3>Billables</h3>
    <%= render 'refinery/business/billables/table', table_id: 'invoice_billables_table', ajax: refinery.business_billables_path(invoice_id: @invoice.id), options: { view: :invoice } %>

    <% if false #@invoice.billables.any? %>
      <table>
        <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Article</th>
          <th>Qty</th>
          <th>Unit Price</th>
          <th>Discount</th>
          <th>Total</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody>
        <% @invoice.billables.each do |billable| %>
          <tr>
            <td><%= link_to billable.title, refinery.business_billable_path(billable) %></td>
            <td><%= billable.billable_date %></td>
            <td><%= billable.article_code %></td>
            <td><%= billable.display_qty %></td>
            <td><%=number_to_currency billable.unit_price %></td>
            <td><%=number_to_percentage billable.discount %></td>
            <td><%=number_to_currency billable.total_cost %></td>
            <td><%= billable.status %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No Billables added</p>
    <% end %>
  </section>
<% end %>

<%= render '/refinery/content_page' %>
