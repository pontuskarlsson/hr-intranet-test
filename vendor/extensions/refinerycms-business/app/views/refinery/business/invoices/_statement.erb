<% content_for :head do %>
  <style type="text/css">
    .billables {
      width: 100%;
    }
    .billables td, .billables th {
      padding-bottom: 0.6rem;
    }
    .billables tfoot td, .billables tfoot th {
      padding-top: 1rem;
    }
    .billables td:nth-child(1), .billables th:nth-child(1) { width: 60px; }
    .billables td:nth-child(3), .billables th:nth-child(3) { width: 120px; }
    .billables td:nth-child(4), .billables th:nth-child(4) { width: 120px; }
    .billables td:nth-child(5), .billables th:nth-child(5) { width: 120px; }

    .billables.total td:nth-child(1), .billables.total th:nth-child(1) { width: auto; }
    .billables.total td:nth-child(2), .billables.total th:nth-child(2) { width: 120px; }

    table.summary_of_work > tbody > tr > td:nth-child(odd) {
      width: 28%;
    }

    table.summary_of_work > tbody > tr > td:nth-child(even) {
      width: 8%;
    }

    table.details_of_work {
      margin: 2rem 0 1rem;
    }
    table.details_of_work td, table.details_of_work th {
      padding-bottom: 0.6rem;
    }
    table.details_of_work > tbody > tr > td:nth-child(1) { width: 100px; }
    table.details_of_work > tbody > tr > td:nth-child(2) { width: 160px; }
    table.details_of_work > tbody > tr > td:nth-child(3) { width: auto; }
    table.details_of_work > tbody > tr > td:nth-child(4) { width: 80px; }
    table.details_of_work > tbody > tr > td:nth-child(5) { width: 100px; }
  </style>
<% end %>

<section class="invoice_plan_summary">
  <h1 style="overflow: hidden; height: 2px;">Invoice</h1>
  <h2 style="margin: 0 0 0.5rem;"><%= @invoice.plan_title %></h2>
  <p class="italic"><%= @invoice.plan_description %></p>

  <table class="billables">
    <thead>
    <tr>
      <th>Quantity</th>
      <th>Description</th>
      <th class="currency">Unit Price, <%= @invoice.currency_code %></th>
      <th class="currency">Discount</th>
      <th class="currency">Amount, <%= @invoice.currency_code %></th>
    </tr>
    </thead>
    <tbody>
    <% invoice.monthly_billables.each do |monthly_billable| %>
      <tr>
        <td><%= monthly_billable['monthly_minimum_qty'] %></td>
        <td><%= monthly_billable['article'].name %></td>
        <td class="currency"><%=number_to_currency monthly_billable['base_amount'].to_f, unit: '' %></td>
        <td class="currency"><%=number_to_currency monthly_billable['discount_amount'].present? ? -monthly_billable['discount_amount'].to_f : '', unit: '' %></td>
        <td class="currency"><%=number_to_currency (monthly_billable['base_amount'].to_f - monthly_billable['discount_amount'].to_f) * monthly_billable['monthly_minimum_qty'].to_f, unit: '' %></td>
      </tr>
    <% end %>
    </tbody>
    <tfoot>
    <tr>
      <th colspan="4" class="currency">Subtotal, <%= @invoice.currency_code %></th>
      <th class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></th>
    </tr>
    </tfoot>
  </table>

  <hr style="margin-top: 2rem;"/>

  <table class="billables total">
    <tbody>
      <tr>
        <td class="currency">Subtotal, <%= @invoice.currency_code %></td>
        <td class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">Invoice Total, <%= @invoice.currency_code %></td>
        <td class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">Less Payments, <%= @invoice.currency_code %></td>
        <td class="currency">-<%=number_to_currency 0, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">&nbsp;</td>
        <td class="currency">&nbsp;</td>
      </tr>
      <tr>
        <th class="currency">Amount Due, <%= @invoice.currency_code %></th>
        <th class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></th>
      </tr>
    </tbody>
  </table>
</section>

<div class="alwaysbreak"></div>

<section class="invoice_plan_statement">
  <h1 style="overflow: hidden; height: 2px;">Summary</h1>
  <h2 style="margin: 0 0 0.5rem;"><%= @invoice.plan_title %></h2>
  <p class="italic"><%= @invoice.plan_description %></p>

  <table class="summary_of_work">
    <thead>
    <tr>
      <th>Statement of Work</th>
      <th>&nbsp;</th>
      <th>Credits - QC/QA Man Days</th>
      <th>&nbsp;</th>
      <th>Statistics</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>
        <table>
          <tbody>
          <tr>
            <td>No. of Man Days</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_man_days %></td>
          </tr>
          <tr>
            <td>No. of Inspections</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_inspections %></td>
          </tr>
          <tr>
            <td>No. of Pieces Inspected</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_pieces_inspected %></td>
          </tr>
          <tr>
            <td>No. of Locations</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_locations %></td>
          </tr>
          </tbody>
        </table>
      </td>

      <td>&nbsp;</td>

      <td>
        <table>
          <tbody>
          <tr>
            <td>Opening Balance</td>
            <td class="number"><%=number_with_delimiter @invoice.plan_opening_balance %></td>
          </tr>
          <tr>
            <td>Redeemed</td>
            <td class="number"><%=number_with_delimiter @invoice.plan_redeemed %></td>
          </tr>
          <tr>
            <td>Issued</td>
            <td class="number"><%=number_with_delimiter @invoice.plan_issued %></td>
          </tr>
          <tr>
            <td>Closing Balance</td>
            <td class="number"><%=number_with_delimiter @invoice.plan_closing_balance %></td>
          </tr>
          </tbody>
        </table>
      </td>

      <td>&nbsp;</td>

      <td>
        <table>
          <tbody>
          <tr>
            <td>Final Insp. Pass Rate</td>
            <td class="number"><%=number_to_percentage @invoice.final_insp_pass_rate * 100, precision: 1, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>In-line Defects Found</td>
            <td class="number"><%=number_with_delimiter @invoice.inline_defects_found %></td>
          </tr>
          <tr>
            <td>In-line Defects Fixable?</td>
            <td class="number"><%=number_with_delimiter @invoice.inline_defects_fixable %></td>
          </tr>
          </tbody>
        </table>
      </td>
    </tr>
    </tbody>
  </table>

  <% @invoice.billables.group_by(&:article).each do |article, billables| %>
    <table class="details_of_work">
      <thead>
      <tr>
        <th colspan="5"><%= article.description %> During the Period</th>
      </tr>
      <tr>
        <th>Date</th>
        <th>Staff</th>
        <th>Vendor</th>
        <th class="number">Days</th>
        <th class="number">Inspections</th>
      </tr>
      </thead>
      <tbody>
      <% billables.sort_by(&:billable_date).each do |billable| %>
        <tr>
          <td><%= billable.display_billable_date(billable.billable_date&.year == @invoice.invoice_for_month&.year ? '%e %b' : '%e %b %Y') %></td>
          <td><%= billable.assigned_to_label %></td>
          <td><%= billable.supplier %></td>
          <td class="number"><%=number_with_delimiter billable.qty %></td>
          <td class="number"><%= billable.total_no_of_jobs %></td>
        </tr>
      <% end %>
      </tbody>
      <tfoot>
      <tr>
        <th colspan="3">Total</th>
        <th class="number"><%=number_with_delimiter billables.reduce(0) { |acc, b| acc + b.qty } %></th>
        <th class="number"><%=number_with_delimiter billables.reduce(0) { |acc, b| acc + b.total_no_of_jobs } %></th>
      </tr>
      </tfoot>
    </table>
  <% end %>

</section>

