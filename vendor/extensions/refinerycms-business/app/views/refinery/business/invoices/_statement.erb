<%- timezone = @invoice.company.company_users.owner.first&.user&.timezone.presence || 'UTC'
%>

<% content_for :head do %>
  <style type="text/css">
    .billables {
      width: 100%;
    }
    .billables td, .billables th {
      padding-bottom: 0.6rem;
    }
    .billables tfoot td, .billables tfoot th {
      padding-top: 1rem;
    }
    .billables td:nth-child(1), .billables th:nth-child(1) { width: 60px; }
    .billables td:nth-child(3), .billables th:nth-child(3) { width: 120px; }
    .billables td:nth-child(4), .billables th:nth-child(4) { width: 120px; }
    .billables td:nth-child(5), .billables th:nth-child(5) { width: 120px; }

    .billables.total td:nth-child(1), .billables.total th:nth-child(1) { width: auto; }
    .billables.total td:nth-child(2), .billables.total th:nth-child(2) { width: 120px; }

    table.summary_of_work > tbody > tr > td:nth-child(odd) {
      width: 28%;
    }

    table.summary_of_work > tbody > tr > td:nth-child(even) {
      width: 8%;
    }

    table.details_of_work {
      margin: 2rem 0 1rem;
    }
    table.details_of_work td, table.details_of_work th {
      padding-bottom: 0.6rem;
    }
    table.details_of_work > tbody > tr > td:nth-child(1) { width: 100px; }
    table.details_of_work > tbody > tr > td:nth-child(2) { width: 160px; }
    table.details_of_work > tbody > tr > td:nth-child(3) { width: auto; }
    table.details_of_work > tbody > tr > td:nth-child(4) { width: 80px; }
    table.details_of_work > tbody > tr > td:nth-child(5) { width: 100px; }
  </style>
<% end %>

<section class="invoice_plan_summary">
  <h1 style="overflow: hidden; height: 2px;">Invoice</h1>
  <h2 style="margin: 0 0 0.5rem;"><%= @invoice.plan_title %></h2>
  <div class="italic"><%=simple_format @invoice.plan_description %></div>

  <table class="billables">
    <thead>
    <tr>
      <th>Quantity</th>
      <th>Description</th>
      <th class="currency">Unit Price</th>
      <th class="currency">Unit Discount</th>
      <th class="currency">Amount</th>
    </tr>
    </thead>
    <tbody>
    <% invoice.invoice_items.sales_purchase.each do |invoice_item|
      qty = invoice_item.quantity - invoice_item.redeemed_vouchers.count

      # One turn first to allocate only minimum
      invoice.minimums.each do |mm|
        min = [mm.unallocated, qty].min
        if mm.allocated_to?(invoice_item.item_code, min)
          qty -= min
        end
      end

      # Second round to allocate any remaining
      invoice.minimums.each do |mm|
        if qty > 0 && mm.applicable_to?(invoice_item.item_code)
          mm.allocate_additional qty
          qty = 0
        end
      end

      if qty > 0
        # Even though it is not a minimum, we add it to the same array. But since the qty is 0, it will be
        # excluded from the minimum list and only presented in the additional view.
        invoice.minimums << mm = Refinery::Business::Charge.new(
            0,
            invoice_item.item_code,
            invoice_item.unit_amount,
            0
        )

        mm.allocate_additional qty
      end
    end
    %>

    <%# Issued Vouchers %>
    <% invoice.minimums.each do |charge| %>
      <% if charge.qty > 0 %>
        <tr>
          <td><%=number_with_precision charge.qty + charge.additional_qty, strip_insignificant_zeros: true %></td>
          <td><%= charge.article&.name %> - Issued</td>
          <td class="currency"><%=number_to_currency charge.base_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.discount_amount.present? ? charge.discount_amount : '', unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.total_amount, unit: '' %></td>
        </tr>
      <% end %>
    <% end %>
    <% if false %>
    <% invoice.minimums.each do |charge| %>
      <% if charge.additional_qty > 0 %>
        <tr>
          <td><%=number_with_precision charge.additional_qty, strip_insignificant_zeros: true %></td>
          <td><%= charge.article&.name %></td>
          <td class="currency"><%=number_to_currency charge.base_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.discount_amount.present? ? charge.discount_amount : '', unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.total_additional_amount, unit: '' %></td>
        </tr>
      <% end %>
    <% end %>
    <% end %>

    <%# Sold Products & Services %>
    <% invoice.invoice_items.sales_purchase.each do |invoice_item| %>
      <% invoice_item.vouchers_by_discount.each_pair do |discount_amount, vouchers| %>
        <tr>
          <td><%=number_with_precision vouchers.count, strip_insignificant_zeros: true %></td>
          <td><%= invoice_item.article&.name %></td>
          <td class="currency"><%=number_to_currency invoice_item.unit_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency discount_amount == 0 ? '' : discount_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency vouchers.count * (invoice_item.unit_amount + discount_amount), unit: '' %></td>
        </tr>
      <% end %>
    <% end %>

    <tr>
      <td colspan="5" class="currency">&nbsp;</td>
    </tr>
    <tr>
      <th colspan="5">Redeemed Credits</th>
    </tr>

    <%# Redeemed Vouchers %>
    <% invoice.invoice_items.sales_purchase.each do |invoice_item| %>
      <% invoice_item.vouchers_by_issued_invoice.each_pair do |(issued_by_invoice, discount_amount), vouchers| %>
        <tr>
          <td><%=number_with_precision vouchers.count, strip_insignificant_zeros: true %></td>
          <td>
            <%= invoice_item.article&.name %>
            from
            <% if issued_by_invoice == invoice %>
              this invoice
            <% else %>
              <%= issued_by_invoice.statement_number %>
              Issued
              <%= issued_by_invoice.display_invoice_date %>
            <% end %>
          </td>
          <td class="currency"><%=number_to_currency -invoice_item.unit_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency discount_amount == 0 ? '' : -discount_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency -vouchers.count * (invoice_item.unit_amount + discount_amount), unit: '' %></td>
        </tr>
      <% end %>
    <% end %>

    </tbody>
    <tfoot>
    <tr>
      <th colspan="4" class="currency">Subtotal, <%= @invoice.currency_code %></th>
      <th class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></th>
    </tr>
    </tfoot>
  </table>

  <hr style="margin-top: 2rem;"/>

  <table class="billables total">
    <tbody>
      <tr>
        <td class="currency">Subtotal, <%= @invoice.currency_code %></td>
        <td class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">Invoice Total, <%= @invoice.currency_code %></td>
        <td class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">Less Payments, <%= @invoice.currency_code %></td>
        <td class="currency">-<%=number_to_currency 0, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">&nbsp;</td>
        <td class="currency">&nbsp;</td>
      </tr>
      <tr>
        <th class="currency">Amount Due, <%= @invoice.currency_code %></th>
        <th class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></th>
      </tr>
    </tbody>
  </table>
</section>

<div class="alwaysbreak"></div>

<section class="invoice_plan_statement">
  <h1 style="overflow: hidden; height: 2px;">Summary</h1>
  <h2 style="margin: 0 0 0.5rem;"><%= @invoice.plan_title %></h2>
  <div class="italic"><%=simple_format @invoice.plan_description %></div>

  <table class="summary_of_work">
    <thead>
    <tr>
      <th>Statement of Work</th>
      <th>&nbsp;</th>
      <th>Manday Credits</th>
      <th>&nbsp;</th>
      <th>Statistics</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>
        <table>
          <tbody>
          <tr>
            <td>Mandays</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_man_days %></td>
          </tr>
          <tr>
            <td>Inspections</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_inspections %></td>
          </tr>
          <tr>
            <td>Pieces Inspected</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_pieces_inspected %></td>
          </tr>
          <tr>
            <td>Locations Visited</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_locations %></td>
          </tr>
          </tbody>
        </table>
      </td>

      <td>&nbsp;</td>

      <td>
        <table>
          <tbody>
          <tr>
            <td>Opening Balance</td>
            <td class="number"><%=number_with_precision @invoice.plan_opening_balance.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Issued</td>
            <td class="number"><%=number_with_precision @invoice.plan_issued.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Redeemed</td>
            <td class="number"><%=number_with_precision @invoice.plan_redeemed.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Closing Balance</td>
            <td class="number"><%=number_with_precision @invoice.plan_closing_balance.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          </tbody>
        </table>
      </td>

      <td>&nbsp;</td>

      <td>
        <table>
          <tbody>
          <tr>
            <td>In-line Inspections</td>
            <td class="number"><%=number_with_precision @invoice.inspections('In-line').count, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Final Inspections</td>
            <td class="number"><%=number_with_precision @invoice.inspections('Final').count, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Final Insp. Pass Rate</td>
            <td class="number"><%=number_to_percentage @invoice.final_insp_pass_rate * 100, strip_insignificant_zeros: true %></td>
          </tr>
          </tbody>
        </table>
      </td>
    </tr>
    </tbody>
  </table>

  <% @invoice.billables.includes(:article, :billed_company).order(:billable_date).group_by(&:article).each do |article, billables| %>
    <table class="details_of_work">
      <thead>
      <tr>
        <th colspan="5"><%= article.description %> During the Period</th>
      </tr>
      <tr>
        <th>Date</th>
        <th>Staff</th>
        <th>Vendor</th>
        <th class="number">Days</th>
        <th class="number">Inspections</th>
      </tr>
      </thead>
      <tbody>
      <%- own_billables = billables.select(&:bill_own_company?) %>
      <%- billables_by_other_company = billables.select(&:bill_other_company?).group_by(&:billed_company) %>
      <% if own_billables.any? %>
        <% own_billables.each do |billable| %>
          <tr>
            <td><%= billable.display_billable_date(billable.billable_date&.year == @invoice.invoice_for_month&.year ? '%e %b' : '%e %b %Y') %></td>
            <td><%= billable.assigned_to_label %></td>
            <td>
              <%= "#{billable.supplier} - #{billable.manufacturer_label}".truncate(63) %>
              <% if billable.description.present? %>
                <div class="italic"><%=simple_format billable.description %></div>
              <% end %>
            </td>
            <td class="number"><%=number_with_delimiter billable.qty %></td>
            <td class="number"><%= billable.total_no_of_jobs %></td>
          </tr>
        <% end %>
        <% if billables_by_other_company.any? %>
          <tr>
            <th colspan="3" style="text-align: right;">Sub-total</th>
            <th class="number"><%=number_with_delimiter own_billables.reduce(0) { |acc, b| acc + b.qty } %></th>
            <th class="number"><%=number_with_delimiter own_billables.reduce(0) { |acc, b| acc + b.total_no_of_jobs } %></th>
          </tr>
        <% end %>
      <% end %>
      <% billables_by_other_company.each_pair do |company, other_billables| %>
        <tr>
          <td colspan="5" class="italic">Paid for by <%= company.nil? ? 'Happy Rabbit Limited' : company.name %></td>
        </tr>
        <% other_billables.each do |billable| %>
          <tr>
            <td><%= billable.display_billable_date(billable.billable_date&.year == @invoice.invoice_for_month&.year ? '%e %b' : '%e %b %Y') %></td>
            <td><%= billable.assigned_to_label %></td>
            <td>
              <%= "#{billable.supplier} - #{billable.manufacturer_label}".truncate(63) %>
              <% if billable.description.present? %>
                <div class="italic"><%=simple_format billable.description %></div>
              <% end %>
            </td>
            <td class="number"><%=number_with_delimiter billable.qty %></td>
            <td class="number"><%= billable.total_no_of_jobs %></td>
          </tr>
        <% end %>
        <% if own_billables.any? || billables_by_other_company.keys.length > 1 %>
          <tr>
            <th colspan="3" style="text-align: right;">Sub-total</th>
            <th class="number"><%=number_with_delimiter other_billables.reduce(0) { |acc, b| acc + b.qty } %></th>
            <th class="number"><%=number_with_delimiter other_billables.reduce(0) { |acc, b| acc + b.total_no_of_jobs } %></th>
          </tr>
        <% end %>
      <% end %>
      </tbody>
      <tfoot>
      <tr>
        <th colspan="3" style="text-align: right;">Total</th>
        <th class="number"><%=number_with_delimiter billables.reduce(0) { |acc, b| acc + b.qty } %></th>
        <th class="number"><%=number_with_delimiter billables.reduce(0) { |acc, b| acc + b.total_no_of_jobs } %></th>
      </tr>
      </tfoot>
    </table>
  <% end %>

</section>

