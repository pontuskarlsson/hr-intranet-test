<% content_for :head do %>
  <style type="text/css">
    .billables {
      width: 100%;
    }
    .billables td, .billables th {
      padding-bottom: 0.6rem;
    }
    .billables tfoot td, .billables tfoot th {
      padding-top: 1rem;
    }
    .billables td:nth-child(1), .billables th:nth-child(1) { width: 60px; }
    .billables td:nth-child(3), .billables th:nth-child(3) { width: 120px; }
    .billables td:nth-child(4), .billables th:nth-child(4) { width: 120px; }
    .billables td:nth-child(5), .billables th:nth-child(5) { width: 120px; }

    .billables.total td:nth-child(1), .billables.total th:nth-child(1) { width: auto; }
    .billables.total td:nth-child(2), .billables.total th:nth-child(2) { width: 120px; }

    table.summary_of_work > tbody > tr > td:nth-child(odd) {
      width: 28%;
    }

    table.summary_of_work > tbody > tr > td:nth-child(even) {
      width: 8%;
    }

    table.details_of_work {
      margin: 2rem 0 1rem;
    }
    table.details_of_work td, table.details_of_work th {
      padding-bottom: 0.6rem;
    }
    table.details_of_work > tbody > tr > td:nth-child(1) { width: 100px; }
    table.details_of_work > tbody > tr > td:nth-child(2) { width: 160px; }
    table.details_of_work > tbody > tr > td:nth-child(3) { width: auto; }
    table.details_of_work > tbody > tr > td:nth-child(4) { width: 80px; }
    table.details_of_work > tbody > tr > td:nth-child(5) { width: 100px; }
  </style>
<% end %>

<section class="invoice_plan_summary">
  <h1 style="overflow: hidden; height: 2px;">Invoice</h1>
  <h2 style="margin: 0 0 0.5rem;"><%= @invoice.plan_title %></h2>
  <div class="italic"><%=simple_format @invoice.plan_description %></div>

  <table class="billables">
    <thead>
    <tr>
      <th>Quantity</th>
      <th>Description</th>
      <th class="currency">Unit Price</th>
      <th class="currency">Unit Discount</th>
      <th class="currency">Amount</th>
    </tr>
    </thead>
    <tbody>
    <% invoice.invoice_items.sales.each do |invoice_item|
      qty = invoice_item.quantity - invoice_item.redeemed_vouchers.count

      # One turn first to allocate only minimum
      invoice.minimums.each do |mm|
        min = [mm.unallocated, qty].min
        if mm.allocated_to?(invoice_item.item_code, min)
          qty -= min
        end
      end

      # Second round to allocate any remaining
      invoice.minimums.each do |mm|
        if qty > 0 && mm.applicable_to?(invoice_item.item_code)
          mm.allocate_additional qty
          qty = 0
        end
      end

      if qty > 0
        # Even though it is not a minimum, we add it to the same array. But since the qty is 0, it will be
        # excluded from the minimum list and only presented in the additional view.
        invoice.minimums << mm = Refinery::Business::Invoice::Charge.new(
            0,
            invoice_item.item_code,
            invoice_item.unit_amount,
            0
        )

        mm.allocate_additional qty
      end
    end
    %>
    <% invoice.minimums.each do |charge| %>
      <% if charge.qty > 0 %>
        <tr>
          <td><%=number_with_precision charge.qty, strip_insignificant_zeros: true %></td>
          <td><%= charge.article&.name %> - Minimum</td>
          <td class="currency"><%=number_to_currency charge.base_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.discount_amount.present? ? charge.discount_amount : '', unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.total_amount, unit: '' %></td>
        </tr>
      <% end %>
    <% end %>
    <% invoice.minimums.each do |charge| %>
      <% if charge.additional_qty > 0 %>
        <tr>
          <td><%=number_with_precision charge.additional_qty, strip_insignificant_zeros: true %></td>
          <td><%= charge.article&.name %></td>
          <td class="currency"><%=number_to_currency charge.base_amount, unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.discount_amount.present? ? charge.discount_amount : '', unit: '' %></td>
          <td class="currency"><%=number_to_currency charge.total_additional_amount, unit: '' %></td>
        </tr>
      <% end %>
    <% end %>
    </tbody>
    <tfoot>
    <tr>
      <th colspan="4" class="currency">Subtotal, <%= @invoice.currency_code %></th>
      <th class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></th>
    </tr>
    </tfoot>
  </table>

  <hr style="margin-top: 2rem;"/>

  <table class="billables total">
    <tbody>
      <tr>
        <td class="currency">Subtotal, <%= @invoice.currency_code %></td>
        <td class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">Invoice Total, <%= @invoice.currency_code %></td>
        <td class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">Less Payments, <%= @invoice.currency_code %></td>
        <td class="currency">-<%=number_to_currency 0, unit: '' %></td>
      </tr>
      <tr>
        <td class="currency">&nbsp;</td>
        <td class="currency">&nbsp;</td>
      </tr>
      <tr>
        <th class="currency">Amount Due, <%= @invoice.currency_code %></th>
        <th class="currency"><%=number_to_currency @invoice.total_amount, unit: '' %></th>
      </tr>
    </tbody>
  </table>
</section>

<div class="alwaysbreak"></div>

<section class="invoice_plan_statement">
  <h1 style="overflow: hidden; height: 2px;">Summary</h1>
  <h2 style="margin: 0 0 0.5rem;"><%= @invoice.plan_title %></h2>
  <div class="italic"><%=simple_format @invoice.plan_description %></div>

  <table class="summary_of_work">
    <thead>
    <tr>
      <th>Statement of Work</th>
      <th>&nbsp;</th>
      <th>Credits - QA/QC Man Days</th>
      <th>&nbsp;</th>
      <th>Statistics</th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>
        <table>
          <tbody>
          <tr>
            <td>Man Days</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_man_days %></td>
          </tr>
          <tr>
            <td>Inspections</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_inspections %></td>
          </tr>
          <tr>
            <td>Pieces Inspected</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_pieces_inspected %></td>
          </tr>
          <tr>
            <td>Locations Visited</td>
            <td class="number"><%=number_with_delimiter @invoice.number_of_locations %></td>
          </tr>
          </tbody>
        </table>
      </td>

      <td>&nbsp;</td>

      <td>
        <table>
          <tbody>
          <tr>
            <td>Opening Balance</td>
            <td class="number"><%=number_with_precision @invoice.plan_opening_balance.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Redeemed</td>
            <td class="number"><%=number_with_precision @invoice.plan_redeemed.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Issued</td>
            <td class="number"><%=number_with_precision @invoice.plan_issued.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Closing Balance</td>
            <td class="number"><%=number_with_precision @invoice.plan_closing_balance.to_f, strip_insignificant_zeros: true %></td>
          </tr>
          </tbody>
        </table>
      </td>

      <td>&nbsp;</td>

      <td>
        <table>
          <tbody>
          <tr>
            <td>In-line Inspections</td>
            <td class="number"><%=number_with_precision @invoice.inspections('In-line').count, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Final Inspections</td>
            <td class="number"><%=number_with_precision @invoice.inspections('Final').count, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>Final Insp. Pass Rate</td>
            <td class="number"><%=number_to_percentage @invoice.final_insp_pass_rate * 100, strip_insignificant_zeros: true %></td>
          </tr>
          <% if false %>
          <tr>
            <td>In-line Defects Found</td>
            <td class="number"><%=number_with_precision @invoice.inline_defects_found, strip_insignificant_zeros: true %></td>
          </tr>
          <tr>
            <td>In-line Defects Fixable?</td>
            <td class="number"><%=number_with_precision @invoice.inline_defects_fixable, strip_insignificant_zeros: true %></td>
          </tr>
          <% end %>
          </tbody>
        </table>
      </td>
    </tr>
    </tbody>
  </table>

  <% @invoice.billables.group_by(&:article).each do |article, billables| %>
    <table class="details_of_work">
      <thead>
      <tr>
        <th colspan="5"><%= article.description %> During the Period</th>
      </tr>
      <tr>
        <th>Date</th>
        <th>Staff</th>
        <th>Vendor</th>
        <th class="number">Days</th>
        <th class="number">Inspections</th>
      </tr>
      </thead>
      <tbody>
      <% billables.sort_by(&:billable_date).each do |billable| %>
        <tr>
          <td><%= billable.display_billable_date(billable.billable_date&.year == @invoice.invoice_for_month&.year ? '%e %b' : '%e %b %Y') %></td>
          <td><%= billable.assigned_to_label %></td>
          <td>
            <%= "#{billable.supplier} - #{billable.manufacturer_label}".truncate(63) %>
            <% if billable.description.present? %>
              <div class="italic"><%=simple_format billable.description %></div>
            <% end %>
          </td>
          <td class="number"><%=number_with_delimiter billable.qty %></td>
          <td class="number"><%= billable.total_no_of_jobs %></td>
        </tr>
      <% end %>
      </tbody>
      <tfoot>
      <tr>
        <th colspan="3">Total</th>
        <th class="number"><%=number_with_delimiter billables.reduce(0) { |acc, b| acc + b.qty } %></th>
        <th class="number"><%=number_with_delimiter billables.reduce(0) { |acc, b| acc + b.total_no_of_jobs } %></th>
      </tr>
      </tfoot>
    </table>
  <% end %>

</section>

