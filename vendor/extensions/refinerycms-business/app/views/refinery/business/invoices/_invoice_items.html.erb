<%= form_for invoice_items_build_form, url: refinery.build_business_invoice_path do |f| %>
  <%= render '/refinery/admin/error_messages',
             :object => invoice_items_build_form,
             :include_object_name => true %>

  <div class="grid-x grid-padding-x">
    <div class="cell">
      <%= f.label :invoice_for_month %>
      <%= f.date_field :invoice_for_month %>
    </div>
  </div>

  <div data-form-container="invoice-monthly-minimum" class="form-addable">
    <div class="form-addable-controls">
      <i class="fa fa-plus-square form-ctrl-add"></i>
    </div>

    <div class="form-addable-record">
      <%= render 'monthly_minimum_form', f: f, i: 0 %>
    </div>

    <% content_for :javascripts do %>
      <script type="text/javascript">
        var onAddForm = function() {
          $('.js_article_field').autocomplete({
            source: <%= ::Refinery::Business::Article.voucher.is_public.to_source %>
          });
        };

        $(function() {
          onAddForm();

          Addable.partials["invoice-monthly-minimum"] = {
            "attributes": { "__index__": <%= 1 %> },
            "template": "<%= escape_javascript render('monthly_minimum_form', i: '__index__', f: f) %>",
            "onAdd": onAddForm,
          };
        });
      </script>
    <% end %>
  </div>

  <p><%= submit_tag 'Build', class: 'button' %></p>
<% end %>

<table class="invoice_grid_table">
  <thead>
  <tr>
    <th>#</th>
    <th>Item Code</th>
    <th>Description</th>
    <th>Qty</th>
    <th>Unit Price</th>
    <th>Account</th>
    <th>Type</th>
    <th>Amount</th>
  </tr>
  </thead>
  <tbody>
  <% invoice.invoice_items.in_order.each do |invoice_item| %>
    <tr>
      <td><%= invoice_item.line_item_order %></td>
      <td><span class="item-code"><%= invoice_item.item_code %></span></td>
      <td><%= invoice_item.description.to_s.gsub(/\[([A-Z-]+)(?:{(.*)})?\]/) { |m|
        if $~[2].present?
          content_tag(:span, $~[1], title: $~[2], class: 'has-tip inline-article', 'aria-haspopup': 'true', data: { tooltip: 'true' }).html_safe
        else
          content_tag(:span, $~[1], class: 'inline-article').html_safe
        end
      }.html_safe %></td>
      <td class="number"><%= invoice_item.quantity %></td>
      <td class="currency <%= invoice_item.unit_amount&.negative? ? 'negative' : '' %>"><%=number_to_currency invoice_item.unit_amount %></td>
      <td><%= invoice_item.account_code %></td>
      <td><%= invoice_item.display_transaction_type %></td>
      <td class="currency <%= invoice_item.line_amount&.negative? ? 'negative' : '' %>"><%=number_to_currency invoice_item.line_amount %></td>
    </tr>
  <% end %>
  </tbody>
</table>
