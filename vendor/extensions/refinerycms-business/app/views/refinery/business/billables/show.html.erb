<% content_for :body do %>
  <h2><%= @billable.title %></h2>

  <section class="contact-card">
    <% if page_role?(Refinery::Business::ROLE_INTERNAL_FINANCE) %>
      <%= render 'form' %>
    <% else %>
      <table class="cc-table">
        <tbody>
        <tr>
          <th style="width: 150px;">Title</th>
          <td><%= @billable.title %></td>
        </tr>
        <tr>
          <th>Description</th>
          <td><%= @billable.description %></td>
        </tr>
        <tr>
          <th>Company</th>
          <td>
            <% if @billable.company.present? %>
              <%= link_to @billable.company.label, refinery.business_company_path(@billable.company) %>
            <% else %>
              N/A
            <% end %>
          </td>
        </tr>
        <tr>
          <th>Assigned To</th>
          <td><%= @billable.assigned_to_label %></td>
        </tr>
        <tr>
          <th>Date</th>
          <td><%= @billable.billable_date %></td>
        </tr>
        <tr>
          <th>Manufacturer</th>
          <td><%= @billable.manufacturer_label %></td>
        </tr>
        <tr>
          <th>Invoice</th>
          <td><%= @billable.invoice_invoice_number.presence || 'N/A' %></td>
        </tr>
        <tr>
          <th>Article Code</th>
          <td><%= @billable.article_code || 'N/A' %></td>
        </tr>
        <tr>
          <th>Status</th>
          <td><%= @billable.display_status %></td>
        </tr>
        <tr>
          <th>Type</th>
          <td><%= @billable.display_billable_type %></td>
        </tr>
        </tbody>
      </table>
    <% end %>

    <h3>Cost</h3>
    <table class="cc-table">
      <tbody>
      <tr>
        <th style="width: 150px;">Qty</th>
        <td><%= @billable.display_qty %></td>
      </tr>
      <tr>
        <th>Unit Price</th>
        <td><%=number_to_currency @billable.unit_price %></td>
      </tr>
      <tr>
        <th>Unit Discount</th>
        <td><%=number_to_currency @billable.discount %></td>
      </tr>
      <tr>
        <th>Total Cost</th>
        <td><%=number_to_currency @billable.total_cost %></td>
      </tr>
      </tbody>
    </table>

    <h3>Jobs</h3>
    <% @billable.all_jobs.group_by(&:job_type).each_pair do |job_type, jobs| %>
      <table>
        <thead>
        <tr>
          <th>Job</th>
          <th>Type</th>
          <th>Date</th>
          <th>Manufacturer</th>
          <th>Project</th>
        </tr>
        </thead>
        <tbody>
        <% jobs.each do |job| %>
          <tr>
            <td>
              <% if job_type == 'Inspection' %>
                <%= link_to job.title, refinery.quality_assurance_job_path(job) %>
              <% else %>
                <%= job.title %>
              <% end %>
            </td>
            <td><%= job_type %></td>
            <td><%= job.inspection_date %></td>
            <td><%= job.respond_to?(:inspection) && job.inspection&.manufacturer_label %></td>
            <td><%= job.project_label.presence || 'N/A' %></td>
          </tr>
        <% end %>
        </tbody>
        <tfoot>
        <tr>
          <th>Total of <%= jobs.count %> jobs</th>
          <th>&nbsp;</th>
          <th>&nbsp;</th>
          <th>&nbsp;</th>
          <th>&nbsp;</th>
        </tr>
        </tfoot>
      </table>
    <% end %>
  </section>
<% end %>

<% content_for :javascripts do -%>
  <script>
    $(document).ready(function(){
      $('.js_invoice_field').autocomplete({
        source: <%= @billable.company.invoices.to_source %>
      });
      $('.js_article_field').autocomplete({
        source: <%= ::Refinery::Business::Article.non_voucher.is_public.to_source %>
      });
    });
  </script>
<% end -%>

<% content_for :stylesheets do -%>
  <%= stylesheet_link_tag '//ajax.googleapis.com/ajax/libs/jqueryui/1/themes/smoothness/jquery-ui.css' %>
<% end -%>

<%= render '/refinery/content_page' %>
