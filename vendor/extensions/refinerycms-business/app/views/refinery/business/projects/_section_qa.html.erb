<table class="cc-table">
  <tbody>
  <tr>
    <th style="width: 120px;">Type</th>
    <td><%= section.section_type %></td>
  </tr>
  <tr>
    <th>Description</th>
    <td><%= section.description %></td>
  </tr>
  <tr>
      <th>No. of Billables</th>
    <td>
      Total of <%=number_to_human section.jobs_and_allocations.keys.inject(Rational(0)) { |acc, b| acc + b.allocated_by(section) } %> days
      <% if (not_invoiced = section.jobs_and_allocations.keys.select { |b| b.invoice.nil? }).any? %>
        (<%=number_to_human not_invoiced.inject(Rational(0)) { |acc, b| acc + b.allocated_by(section) } %> days not invoiced)
      <% end %>
    </td>
  </tr>
  <tr>
    <th>No. of Jobs</th>
    <td>
      <p>
        <%= section.quality_assurance_jobs.count %>,
        <%= link_to 'View All', refinery.quality_assurance_jobs_path(section_id: section.id) %>
      </p>
    </td>
  </tr>
  </tbody>
</table>

<% if current_authentication_devise_user.has_role?(Refinery::Business::ROLE_INTERNAL_FINANCE) %>
  <% if section.quality_assurance_jobs.any? %>
    <table>
      <thead>
      <tr>
        <th>Billable</th>
        <th>Date</th>
        <th>Assigned To</th>
        <th>Invoice</th>
        <th>Allocated Here</th>
        <th>Job</th>
      </tr>
      </thead>
      <tbody>
      <% section.jobs_and_allocations.each_pair do |billable, allocations| %>
        <tr>
          <td><%= link_to billable.title, refinery.business_billable_path(billable) %></td>
          <td><%= billable.billable_date %></td>
          <td><%= billable.assigned_to_label %></td>
          <td>
            <% if current_authentication_devise_user.has_role?(Refinery::Business::ROLE_INTERNAL_FINANCE) && billable.invoice.present? %>
              <%= link_to billable.invoice_label, refinery.business_invoice_path(billable.invoice) %>
            <% else %>
              <%= billable.invoice_label %>
            <% end %>
          </td>
          <td>
            <%= number_to_human Rational(100) * allocations[:jobs].count / billable.total_no_of_jobs %>%
          </td>
          <td>
            <% allocations[:jobs].each_with_index do |job, i| %>
            <p><%= link_to job.title, refinery.quality_assurance_job_path(job) %></p>
            <% end %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  <% end %>
<% end %>
