<ul class="tabs" data-tabs id="section-qa-content-tabs">
  <li class="tabs-title is-active"><a href="#qa-panel1" aria-selected="true">Cost details</a></li>
  <li class="tabs-title"><a data-tabs-target="qa-panel2" href="#panel2">Analytics: By Supplier</a></li>
</ul>

<div class="tabs-content" data-tabs-content="section-qa-content-tabs">
  <div class="tabs-panel is-active" id="qa-panel1">
    <table class="cc-table">
      <tbody>
      <tr>
        <th style="width: 120px;">Type</th>
        <td><%= section.section_type %></td>
      </tr>
      <tr>
        <th>Description</th>
        <td><%= section.description %></td>
      </tr>
      <tr>
        <th>No. of Billables</th>
        <td>
          Total of <%=number_to_human section.jobs_and_allocations.keys.inject(Rational(0)) { |acc, b| acc + b.allocated_by(section) } %> days
          <% if (not_invoiced = section.jobs_and_allocations.keys.select { |b| b.invoice.nil? }).any? %>
            (<%=number_to_human not_invoiced.inject(Rational(0)) { |acc, b| acc + b.allocated_by(section) } %> days not invoiced)
          <% end %>
        </td>
      </tr>
      <tr>
        <th>No. of Jobs</th>
        <td>
          <p>
            <%= section.quality_assurance_jobs.count %>,
            <%= link_to 'View All', refinery.quality_assurance_jobs_path(section_id: section.id) %>
          </p>
        </td>
      </tr>
      </tbody>
    </table>

    <% if section.quality_assurance_jobs.any? %>
      <table class="display responsive nowrap dt-project-billables" style="width: 100%;">
        <thead>
        <tr>
          <th>Billable</th>
          <th>Date</th>
          <th data-dt-search-input="true">Assigned To</th>
          <th data-dt-search-input="true">Supplier</th>
          <th data-dt-search-input="true">Invoice</th>
          <th>Unit Price</th>
          <th>Unit Disc.</th>
          <th>Tot. Cost</th>
          <th>Alloc. %</th>
          <th>Alloc. Cost</th>
          <th>Job(s)</th>
        </tr>
        </thead>
        <tbody>
        <% section.jobs_and_allocations.each_pair do |billable, allocations| %>
          <tr>
            <td>
              <% if current_authentication_devise_user.has_role?(Refinery::Business::ROLE_INTERNAL) %>
                <%= link_to billable.title, refinery.business_billable_path(billable) %>
              <% else %>
                <%= billable.title %>
              <% end %>
              </td>
            <td><%= billable.billable_date %></td>
            <td><%= billable.assigned_to_label %></td>
            <td><%= billable.supplier_label %></td>
            <td>
              <% if current_authentication_devise_user.has_role?(Refinery::Business::ROLE_INTERNAL_FINANCE) && billable.invoice.present? %>
                <%= link_to billable.invoice_label, refinery.business_invoice_path(billable.invoice) %>
              <% else %>
                <%= billable.invoice_label %>
              <% end %>
            </td>
            <td class="text-align-right"><%= billable.unit_price %></td>
            <td class="text-align-right"><%= billable.discount %></td>
            <td class="text-align-right"><%= billable.total_cost %></td>
            <%- allocated_perc = Rational(1) * allocations[:jobs].count / billable.total_no_of_jobs -%>
            <td class="text-align-right"><%=number_to_human allocated_perc * 100 %>%</td>
            <td class="text-align-right"><%= allocated_perc * billable.total_cost %></td>
            <td class="text-align-right"><%= allocations[:jobs].count %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% end %>
  </div>

  <div class="tabs-panel" id="qa-panel2">
    <h5>Allocated Cost by supplier</h5>

    <%= column_chart [], stacked: true, id: 'js-qa-supplier-chart', colors: ['#48A9A6', '#C1666B', '#D4B483'], background_colors: ['#48A9A6', '#C1666B', '#D4B483'], thousands: ',' %>

    <% content_for :javascripts do %>
      <script type="text/javascript">
        $(function() {
          $(document).on('draw.dt', '.dt-project-supplier-summary', function() {
            var $dt = $('.dt-project-supplier-summary').dataTable();
            var chart = Chartkick.charts['js-qa-supplier-chart'];

            var supplierIdx = {};
            var nextIdx = 0;
            var data = $dt.api().rows({ search: 'applied' }).data().reduce(function(acc, dataRow) {
              console.log(dataRow)
              if (typeof supplierIdx[dataRow[0]] == 'undefined') {
                supplierIdx[dataRow[0]] = nextIdx;
                acc[0].data.push([dataRow[0], 0]);
                nextIdx++;
              }

              acc[0].data[supplierIdx[dataRow[0]]][1] += (parseFloat(dataRow[3]) || 0);

              return acc;
            }, [{ name: 'Tot. Alloc. Cost', data: [] }]);

            chart.updateData(data);
          });
        });
      </script>
    <% end %>


    <% if section.quality_assurance_jobs.any? %>
      <table class="display responsive nowrap dt-project-supplier-summary" style="width: 100%;">
        <thead>
        <tr>
          <th>Supplier</th>
          <th class="text-align-right">No. of Billables</th>
          <th class="text-align-right">No. of Jobs</th>
          <th class="text-align-right">Tot. Alloc. Cost</th>
        </tr>
        </thead>
        <tbody>
        <% section.jobs_and_allocations.group_by { |billable, _|
          billable.supplier_label
        }.each_pair do |supplier_label, jobs_and_allocations| %>
          <tr>
            <td><%= supplier_label %></td>
            <td class="text-align-right"><%= jobs_and_allocations.inject(0.0) { |acc, (billable, allocations)| acc + billable.qty } %></td>
            <td class="text-align-right"><%= jobs_and_allocations.inject(0.0) { |acc, (billable, allocations)| acc + allocations[:jobs].count } %></td>
            <td class="text-align-right"><%= jobs_and_allocations.inject(0.0) { |acc, (billable, allocations)| acc + (Rational(1) * allocations[:jobs].count / billable.total_no_of_jobs) * billable.total_cost } %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>

<%= render 'refinery/datatable_dependencies' %>

<% content_for :javascripts do %>
  <script type="text/javascript">
    $(function() {
      var dtBill = $('.dt-project-billables').DataTable({
        "responsive": true,
        "dom": "<'row grid-x'<'medium-6 columns cell extra-toolbar'B><'medium-6 columns cell'f>r>" +
          "t" +
          "<'row grid-x'<'medium-6 columns cell'i><'medium-6 columns cell'p>>",
        buttons: [
          'excelHtml5'
        ]
      });

      var dtSupp = $('.dt-project-supplier-summary').DataTable({
        "responsive": true,
        "dom": "<'row grid-x'<'medium-6 columns cell extra-toolbar'B><'medium-6 columns cell'f>r>" +
          "t" +
          "<'row grid-x'<'medium-6 columns cell'i><'medium-6 columns cell'p>>",
        buttons: [
          'excelHtml5'
        ]
      });

      initDataTable(dtBill);
      initDataTable(dtSupp);
    });
  </script>
<% end %>
