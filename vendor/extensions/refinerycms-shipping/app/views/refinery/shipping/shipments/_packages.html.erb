<% shipment.packages.build(default_package_fields) if shipment.packages.empty? %>

<%= form_for packages_form, url: [refinery, :shipping, shipment] do |f| %>
  <%= hidden_field_tag 'update_packages', '1' %>

  <div style="margin-top: 1rem;"><%= f.submit 'Save changes', class: 'button primary' %></div>

  <%= render '/refinery/admin/error_messages',
             :object => packages_form,
             :include_object_name => true %>

  <div data-form-container="shipment-packages" class="form-addable">
    <div class="form-addable-controls">
      <i class="fa fa-plus-square form-ctrl-add"></i>
    </div>

    <% shipment.packages.each_with_index do |package, i| %>
      <div class="form-addable-record">
        <%= render 'package_form', f: f, package: package, i: i+1 %>
      </div>
    <% end %>

    <% content_for :javascripts do %>
      <script type="text/javascript">
          $(document).ready(function() {
              Addable.partials["shipment-packages"] = {
                  "attributes": { "__index__": <%= shipment.packages.length+1 %> },
                  "template": "<%= escape_javascript render('package_form', package: ::Refinery::Shipping::Package.new(default_package_fields), i: '__index__', f: f) %>",
              };
          });
      </script>
    <% end %>
  </div>
  <%= render 'edit_manual_packages', shipment: shipment, f: f %>


  <div style="margin-top: 1rem;"><%= f.submit 'Save changes', class: 'button primary' %></div>
<% end %>
