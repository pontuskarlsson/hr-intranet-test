<%= form_for routes_form, url: [refinery, :shipping, shipment] do |f| %>

  <div style="margin-top: 1rem;"><%= f.submit 'Save changes', class: 'button primary' %></div>

  <%= render '/refinery/admin/error_messages',
             :object => routes_form,
             :include_object_name => true %>

  <div class="grid-x grid-padding-x">
    <div class="cell">
      <%= render 'route_form', shipment: shipment, route: shipment.route_origin, f: f, i: 0 %>
    </div>

    <% if shipment.mode == 'Air' || shipment.mode == 'Sea' %>
      <div class="cell">
        <%= render 'route_form', shipment: shipment, route: shipment.route_port_of_loading, f: f, i: 1 %>
      </div>

      <div class="cell">
        <%= render 'route_form', shipment: shipment, route: shipment.route_port_of_discharge, f: f, i: 2 %>
      </div>
    <% end %>

    <div class="cell">
      <%= render 'route_form', shipment: shipment, route: shipment.route_destination, f: f, i: 3 %>
    </div>
  </div>

  <div style="margin-top: 1rem;"><%= f.submit 'Save changes', class: 'button primary' %></div>
<% end %>

<% content_for :stylesheets do -%>
  <%= stylesheet_link_tag '//ajax.googleapis.com/ajax/libs/jqueryui/1/themes/smoothness/jquery-ui.css' %>
<% end -%>

<% content_for :javascripts do %>
  <script type="text/javascript">
    function initMap() {
      $('.js-location-map').each(function(i, node) {
        var $node = $(node);
        setMap(node, $node.data('map-lat'), $node.data('map-lng'))
      });
    }

    function setMap(node, lat, lng) {
      var loc = { lat: parseFloat(lat), lng: parseFloat(lng) };
      if (isNaN(loc.lat) || isNaN(loc.lng)) {
        $(node).html('');

      } else {
        var map = new google.maps.Map(node, {
          zoom: 4, center: loc, fullscreenControl: false, disableDefaultUI: true
        });
        new google.maps.Marker({ position: loc, map: map });
      }
    }

    function setItem($item, item, includeMap) {
      $('.js_location_id', $item).attr('value', item.id);

      var $desc = $('.location-description', $item).html('');

      [item.description, item.street1, item.street2, item.city, item.postal_code, item.state, item.country].filter(function(attr) {
        return attr && attr !== '';
      }).forEach(function(attr, i) {
        if (i > 0) {
          $desc.append(' ');
        }
        $desc.append($('<span></span>').html(attr));
      });

      var codes = [['location_code', 'Code'], ['iata_code', 'IATA'], ['icao_code', 'ICAO']].filter(function(arr) {
        return item[arr[0]] && item[arr[0]] !== '';
      });

      if (codes.length > 0) {
        var $codes = $('<div></div>');
        codes.forEach(function(arr, i) {
          $codes.append($('<span class="tagDT"></span>').html([arr[1], ': ', item[arr[0]]]));
        });
        $desc.prepend($codes);
      }

      if (includeMap) {
        setMap($('.location-map', $item)[0], item.lat, item.lng);
      }
      var $ports = $('<div class="location-ports"><i class="fa fa-plane"></i><i class="fa fa-ship"></i><i class="fa fa-train"></i><i class="fa fa-truck fa-flip-horizontal"></i></div>');
      if (item.airport) { $('.fa-plane', $ports).addClass('port-active'); }
      if (item.railport) { $('.fa-train', $ports).addClass('port-active'); }
      if (item.roadport) { $('.fa-truck', $ports).addClass('port-active'); }
      if (item.seaport) { $('.fa-ship', $ports).addClass('port-active'); }
      $('.location-description', $item).append($ports);
    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_CLOUD_API_KEY'] %>&callback=initMap"></script>

  <script type="text/javascript">
    $(function(){
      $('.js_location_field').each(function(i, node) {
        var field = $(node).autocomplete({
          source: "<%= refinery.locations_shipping_shipment_path(@shipment) %>",
          minLength: 3,
          change: function(event, ui) {
            var item = ui.item || { id: null };
            var $item = $(this).parents('.location-item');
            setItem($item, item, true);
          },
          select: function(event, ui) {
            var item = ui.item || { id: null };
            var $item = $(this).parents('.location-item');
            setItem($item, item, true);
          }
        }).data('ui-autocomplete');

        // Max items to render in dropdown is 5.
        field._renderMenu = function( ul, items ) {
          var that = this;
          $.each(items.slice(0, 5), function (index, item) {
            that._renderItemData(ul, item);
          });
        };

        field._renderItem = function(ul, item) {
          var $node = $('<li class="ui-menu-item"><a class="location-item"><span class="location-map"></span><span class="location-title"></span><span class="location-description"></span></a></li>');

          $('.location-title', $node).html(item.name);
          setItem($('.location-item', $node), item);

          return $node.appendTo(ul);
        };
      });
    });
  </script>
<% end %>
