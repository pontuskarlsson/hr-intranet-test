<div class="row">
  <div class="medium-8 columns">

    <!-- Main Content -->
    <% if @page.images.any? %>
      <section class="page-part">
        <div class="page-part-header">
          HIGHLIGHTS
        </div>
        <ul class="home-orbit" data-orbit data-options="pause_on_hover: false; slide_number: false">
          <% @page.images.each_with_index do |image, image_i| %>
            <li>
              <%= image_tag(image.thumbnail(geometry: '637x300^').url) %>
              <div class="orbit-caption">
                <%=raw @page.caption_for_image_index(image_i) %>
              </div>
            </li>
          <% end %>
        </ul>
      </section>
    <% end %>


    <div class="row">
      <div class="medium-6 columns">

        <section class="page-part">
          <div class="page-part-header">
            NEWS
          </div>

          <% @items = Refinery::News::Item.latest(2) %>
          <% if @items.any? %>
            <ul class="latest-news">
              <% @items.each do |item| %>
                <li>
                  <h5>
                    <%= link_to item.title, refinery.news_item_path(item) %><br/>
                    <small><%= item.publish_date.strftime('%d %b - %I:%M %P') %></small>
                  </h5>
                  <%- truncated_body = truncate  Nokogiri::HTML(item.body).inner_text, length: 200,
                                                omission: "... #{link_to 'Read More', refinery.news_item_path(item)}" -%>
                  <%= truncated_body.split("\r\n").map { |p| "<p>#{p}</p>" }.join.html_safe %>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="italic">No News Items</p>
          <% end %>

        </section>

      </div>
      <div class="medium-6 columns">

        <% if (events = Refinery::Calendar::Event.today.limit(5)).any? %>
          <section class="page-part">
            <div class="page-part-header">
              TODAY IN CALENDAR
            </div>
            <ul class="events">
              <% events.each do |event| %>
                <li>
                  <table>
                    <tr>
                      <td class="event-date">
                        <span class="event-day"><%= event.starts_at.strftime('%d') %></span>
                        <span class="event-month"><%= event.starts_at.strftime('%^b') %></span>
                      </td>
                      <td class="event-description">
                        <% if event.ends_at.present? && event.ends_at.to_date != event.starts_at.to_date %>
                          <h5>- <%= event.ends_at.strftime('%d %^b') %></h5>
                        <% end %>
                        <%= link_to event.title, refinery.calendar_event_path(event) %>
                        <% if event.excerpt.present? %>
                          <div><%= event.excerpt %></div>
                        <% end %>
                      </td>
                    </tr>
                  </table>
                </li>
              <% end %>
            </ul>
          </section>
        <% end %>

        <section class="page-part">
          <div class="page-part-header">
            UPCOMING IN CALENDAR
          </div>

          <% if (events = Refinery::Calendar::Event.where('starts_at >= ?', Date.tomorrow.beginning_of_day).order('starts_at ASC').limit(5)).any? %>
            <ul class="events">
              <% events.each do |event| %>
                <li>
                  <table>
                    <tr>
                      <td class="event-date">
                        <span class="event-day"><%= event.starts_at.strftime('%d') %></span>
                        <span class="event-month"><%= event.starts_at.strftime('%^b') %></span>
                      </td>
                      <td class="event-description">
                        <% if event.ends_at.present? && event.ends_at.to_date != event.starts_at.to_date %>
                          <h5>- <%= event.ends_at.strftime('%d %^b') %></h5>
                        <% end %>
                        <%= link_to event.title, refinery.calendar_event_path(event) %>
                        <% if event.excerpt.present? %>
                          <div><%= event.excerpt %></div>
                        <% end %>
                      </td>
                    </tr>
                  </table>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="italic">No Upcoming Events</p>
          <% end %>
        </section>

      </div>
    </div>


  </div>
  <div class="medium-4 columns">

    <!-- Right Side Column -->
    <% if current_refinery_user.assigned_parcels.unsigned.any? %>
      <section class="page-part">
        <div class="page-part-header">
          NOTIFICATIONS
        </div>

        <p><%= link_to 'You have unsigned Parcels waiting!', refinery.parcels_parcels_path %></p>
      </section>
    <% end %>

    <section class="page-part">
      <div class="page-part-header">
        EMPLOYEE FOCUS
      </div>

      <%- employee = Refinery::Employees::Employee.current.random.first -%>
      <% if employee.profile_image.present? %>
        <%= image_tag(employee.profile_image.thumbnail(geometry: '135x135#c').url, class: 'profile-picture') %>
      <% else %>
        <%= image_tag('user_unknown.png', class: 'profile-picture') %>
      <% end %>
      <h5>
        <%= employee.full_name %><br />
        <% if employee.title.present? %>
          <%= employee.title.upcase %><br />
        <% end %>
      </h5>
    </section>

    <section class="page-part">
      <div class="page-part-header">
        TWITTER
      </div>
      <a class="twitter-timeline" href="https://twitter.com/happyrabbitltd" data-widget-id="395005698821455872">Tweets by @happyrabbitltd</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </section>

  </div>
</div>
