<% content_for :body do %>
  <h1>Contacts</h1>

  <table class="display js_contacts_data_table" cellspacing="0" style="width: 100%;">
    <thead>
    <tr>
      <th>Name</th>
      <th>Code</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Country</th>
      <th>Tags</th>
    </tr>
    </thead>

    <tfoot>
    <tr>
      <th>Name</th>
      <th>Code</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Country</th>
      <th>Tags</th>
    </tr>
    </tfoot>

    <tbody>
    <tr>
      <td colspan="6">Loading, please wait...</td>
    </tr>
    </tbody>
  </table>
<% end %>

<% content_for :stylesheets do %>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/zf/dt-1.10.18/datatables.min.css"/>
<% end %>

<% content_for :javascripts do %>
  <script type="text/javascript" src="https://cdn.datatables.net/v/zf/dt-1.10.18/datatables.min.js"></script>

  <script type="text/javascript">
    $(function(){
      $('.js_contacts_data_table').dataTable({
        "scrollY":        "600px",
        "scrollCollapse": true,
        "paging":         true,
        <% if false %>
        "data":           <%= @contacts.to_json(only: [:id, :name, :code, :is_organisation, :organisation_name, :organisation_id, :email, :phone, :mobile, :country, :tags_joined_by_comma]).html_safe %>,
        <% end %>
        "ajax": "<%= refinery.marketing_contacts_path %>",
        "columns": [
          { data: "name", "width": '20%', "render": function(data, type, row) {
            const href = ["<%= refinery.marketing_contacts_path %>", row.id].join('/');
            const className = ['fa fa-', (row.is_organisation ? 'building' : 'user')].join('');
            return $('<a></a>')
              .attr('href', href)
              .html('<i class="' + className + '"></i> ' + data)
              .prop('outerHTML');
          } },
          { data: "code", "width": '10%' },
          { data: "email", "width": '25%', "render": function(data, type, row) { return ['<span style="white-space: pre-wrap; word-wrap: break-word;">',data ? data : '','</span>'].join('') } },
          { data: "phone", "width": '15%', "render": function(data, type, row){
            if(typeof data == 'undefined' || data === null || data == ''){
              return row.mobile;
            }else{
              return data;
            }
          } },
          { data: "country", "width": '15%' },
          { data: "tags_joined_by_comma", "width": '15%', "render": function(data, type, row) {
            if (typeof data == 'string') {
              var tags = data.split(',');
              var list = [];
              for (var i = 0; i < tags.length; i++) {
                // Ignore import tags
                if (!tags[i].match(/^import/)) {
                  list.push(['<span class="tagDT">',tags[i],'</span>'].join(''))
                }
              }
              return list.join(' ');
            } else {
              return '';
            }
          } }
        ]
      });
    });
  </script>
<% end %>

<%= render '/refinery/content_page' %>
