<p>Dear <%= @target.printable_target_name %>,</p>

<p>A payout from Stripe has just been paid, see reference <%= @notifications[0].notifiable&.reference %>.</p>

<p style="margin: 0 0 30px;">
  Best regards<br/>
  The Happy Rabbit Team
</p>

<table style="margin-bottom: 10px;">
  <thead>
  <tr>
    <th>Invoice</th>
    <th>Xero</th>
    <th>Date</th>
    <th>Customer</th>
    <th style="text-align: right;">Gross, USD</th>
    <th style="text-align: right;">Gross, HKD</th>
    <th style="text-align: right;">Fees, HKD</th>
    <th style="text-align: right;">Net, HKD</th>
  </tr>
  </thead>
  <tbody>
  <%- charges = {} %>
  <%- txns = {} %>
  <% @notifications.each do |notification| %>
    <%- invoice = notification.notifiable %>
    <%- purchase = invoice.purchase %>
    <%-
      charge = nil
      txn = nil
      begin
        charge = charges[purchase.stripe_charge_id] ||= Stripe::Charge.retrieve purchase.stripe_charge_id if purchase&.stripe_charge_id.present?
        txn = txns[charge.balance_transaction]      ||= Stripe::BalanceTransaction.retrieve charge.balance_transaction if charge.present?
      rescue StandardError => e
      end
    %>
    <tr>
      <td><%= link_to invoice.invoice_number, move_notification_url_for(notification, open: true) %></td>
      <td><%= link_to 'Go to', "https://go.xero.com/AccountsReceivable/View.aspx?InvoiceID=#{invoice.invoice_id}" %></td>
      <td><%= invoice.display_invoice_date %></td>
      <td><%= invoice.company_label %></td>
      <td style="text-align: right;"><%= charge && number_to_currency(charge.amount / 100.0, unit: '') %></td>
      <td style="text-align: right;"><%=txn && number_to_currency(txn.amount / 100.0,        unit: '') %></td>
      <td style="text-align: right;"><%=txn && number_to_currency(txn.fee / 100.0,           unit: '') %></td>
      <td style="text-align: right;"><%=txn && number_to_currency(txn.net / 100.0,           unit: '') %></td>
    </tr>
  <% end %>
  </tbody>
</table>
